#!/bin/bash

# @PACKAGE@-@VERSION@ (libxenesis-ral.so) #

# Copyright (C) 2014 Antonio Cao (@burzumishi) #

# This is free software;
# You have unlimited permission to copy and/or distribute it,
# with or without modifications, as long as this notice is preserved.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.

# Xenesis RAL Library #

# libxenesis-ral.so: Remote Administration Layer functions and definitions #

RALFILE_LIST="";
num_ralfile=0;
ralfile_list_reset=0;

# check_ral_plugin($PLUGINS): check for an existent plugin #
function check_ral_plugin {
	# Params: $PLUGINS #
	PLUGINS="$1";

	for plugin in $PLUGINS; do
		ralfile=$($FIND $PLUGINSDIR -iname "${plugin}.ral");

		if [ ! -z "$ralfile" ]; then
			# RAL Plugin found (ralfile) #
			echolog "$OK! Found Plugin: $ralfile";

			# Count RALFILES -> num_ralfile #
			num_ralfile=$((num_ralfile+1));

			# Fill $ralfile -> RALFILE_LIST #
			RALFILE_LIST="$ralfile $RALFILE_LIST";
		else
			# RAL Plugin NOT found (create new ralfile??) #
			echolog "$ERROR! RAL Plugin NOT Found!";

			# Define a dummy plugin name #
			if [ -z "$plugin" ]; then plugin="yourplugin"; fi

			# Ask user for plugin creation #
			echolog "$WARNING! If your RAL Plugin does not exist, you can create a new one.";
			echolog "$WARNING! Use: $EDITOR $PLUGINSDIR/${plugin}.ral"
			$ECHO
			usage;
		fi;	
	done

	RALFILE_LIST=$(echo $RALFILE_LIST | sed -e 's/ $//g');

	echolog_debug "$DEBUG: Loaded #$num_ralfile ralfiles: $RALFILE_LIST";
}

# load_ral_plugin($ralfile_list,$host): Execute ralfile on host # TODO TODO TODO #
function load_ral_plugin {
	# Params: $ralfile_list, $host #
	ralfile_list="$1";
	host="$2";

	for ralfile in $ralfile_list; do
		# TODO TODO TODO #
		echolog "$OK! Deploying <$ralfile> to <$host> ...";
		echolog "$OK! Running <$ralfile> on <$host> ...";
		echolog "$OK! RAL Plugin <$ralfile> status on <$host>: Finished!";
	done

	return $true;
}

# ral($ralfile_list,$hosts): Execute remote administration scripts on hosts and get stdout #
function ral {
	# Params: $ralfile_list, $hosts #
	ralfile_list="$1";
	hosts="$2";

	# Create a valid list of hosts #
	load_host_list "$hosts";
	errorcheck $?;

	# Check HOST_LIST #
	check_host_list;
	errorcheck $?;

	# Load ralplugin on host_list #
	for h in $HOST_LIST; do
		load_ral_plugin "$ralfile_list" $h;
		errorcheck $?;
	done;
}

# start_ral($plugins,$hosts): Execute remote administration scripts on hosts and get stdout #
function start_ral {
	# Start Remote Admin Layer (RAL) Support # libxenesis-ral.so #

	# [option] PLUGIN: must be an existent "plugin name" #
	PLUGINS="$1";

	# [option] HOSTS: must be a valid "host" or "host_list" #
	HOSTS="$2";

	# [option] PLUGIN_PARAMS: should be a "plugin params list" # (OPTIONAL) #
	PLUGIN_PARAMS="$3";

	# Check for Remote Admin Layer (RAL) Plugin File #
	# PLUGIN -> export $RALFILE #
	check_ral_plugin "$PLUGINS";

	# If have Remote Admin Layer (RAL) Plugin file #
	# Load RAL Plugin on each host: "ral $RALFILE_LIST $HOSTS)" #
	ral "$RALFILE_LIST" "$HOSTS";
	errorcheck $?;
}
